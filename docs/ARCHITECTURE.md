# خارطة البنية (النسخة الحالية والقريبة)

هذه الوثيقة تحجز شكل "العمارة النظيفة" المقترحة لـ HabApp دون تغيير السلوك الحالي. الهدف هو فصل منطق النواة عن طبقة Discord لتسهيل التوسع لاحقاً.

## الطبقات المقترحة
- **Core / نواة التطبيق (`src/core/`)**: منطق الأعمال والاستخدام (projects، tasks، templates، status). لا تعتمد على Discord أو واجهات العرض. التخزين الحالي باستخدام JSON مباشر سيبقى هنا إلى أن يتم استبداله بطبقة تخزين.
- **Discord Adapters (`src/discord/`)**: مسؤول عن discord.js (التفاعل مع الأوامر، الردود، إدارة الخيوط والقنوات). تستدعي خدمات النواة عبر سياق واضح.
- **Configuration (`config.json`, المتغيرات البيئية)**: تعريف معرفات الخادم والقنوات. لا ينبغي أن تتسرب إلى النواة إلا عبر محوّلات.
- **Data (`data/`)**: ملفات JSON للتخزين المحلي. ستبقى خلف واجهة `store`/repository عند الفصل الكامل.

## ما هو موجود اليوم
- `src/index.js` يجمع بين Discord والعمليات الأساسية مباشرة (إنشاء مشاريع، إدارة المهام، إنشاء خيوط منتدى، نشر رسائل في قنوات مختلفة).
- `src/core/` يحتوي وحدات مشاريع/مهام/قوالب/حالات، لكنها مرتبطة بتخزين JSON مباشرة دون تهيئة قابلة للحقن.
- `src/commands/` يحتوي تعريفات أوامر السلاش المستخدمة في `deploy-commands.js`.

## ما نحتاجه أثناء الانتقال
1. **تحديد الخدمات / حالات الاستخدام**
   - مشاريع: `findProject`, `listProjects`, `upsertProject`, `deleteProject`.
   - مهام: `createTask`, `completeTask`, `deleteTask`, `listTasks`.
   - قوالب: `getTemplatesByUnit`, `getTemplateById`, `templates` (للعرض فقط).
   - حالات الولاء: `getStatusInfoArabic`, `getStatusRewardsArabic`.

2. **سياق Core**
   - ملف جديد `src/core/context.js` يوفر دالة `createCoreContext` لتمرير هذه الخدمات إلى أي واجهة (Discord اليوم، واجهات أخرى لاحقاً).
   - السياق يتضمن `now` (دالة وقت يمكن استبدالها أثناء الاختبار) و`dataDir` (للتوسع لاحقاً عندما نفصل التخزين عن نظام الملفات).

3. **التحضير لطبقة Discord**
   - إنشاء مجلد `src/discord/` لاستخدامه كمكان للمحوّلات (command handlers, event wiring) بدلاً من العمل داخل `src/index.js` مباشرة.
   - إبقاء `src/index.js` كما هو حالياً، لكنه سيتحول لاحقاً إلى ملف تهيئة يحوّل الأحداث إلى محوّلات `src/discord`.

## ملاحظات عدم تغيير السلوك
- لا توجد تغييرات في التدفق الحالي أو الردود. كل الملفات الجديدة توثيقية/تعريفية لتحضير الفصل فقط.
- بعد تثبيت السياق، يمكن البدء في نقل منطق المشاريع/المهام إلى خدمات تستخدم هذا السياق دون تعديل الردود أو مسارات القنوات.
